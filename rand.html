<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bus Tracking</title>
  <script src="https://apis.mappls.com/advancedmaps/api/7e228cc42a410abe8c713c359a3191a1/map_sdk?layer=vector&v=3.0&callback=initMap" defer async></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body>
  <div id="map" style="width: 100%; height: 400px;"></div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-firestore.js";

    // Initialize Firebase with your configuration
      const firebaseConfig = ({
      apiKey: "AIzaSyB1zdPdHi6njKUgiukk-84RVPEzOJFcAxc",
      authDomain: "vit-bus-tracking.firebaseapp.com",
      databaseURL: "https://vit-bus-tracking-default-rtdb.firebaseio.com",
      projectId: "vit-bus-tracking",
      storageBucket: "vit-bus-tracking.appspot.com",
      messagingSenderId: "832936720267",
      appId: "1:832936720267:web:4f170bd4652b5ae10d618e",
      measurementId: "G-5L7PE5VHHX"
      });
    const app = initializeApp(firebaseConfig);
    const firestore = getFirestore(app);

    // Your map and markers initialization code
    var map, markers = [], startMarker;

    // Function to create polylines from Excel files
    function createPolylineForExcelFile(file, strokeColor) {
      function loadCoordinatesFromExcel(file) {
        return new Promise((resolve, reject) => {
          var xhr = new XMLHttpRequest();
          xhr.open('GET', file, true);
          xhr.responseType = 'arraybuffer';

          xhr.onload = function () {
            var data = new Uint8Array(xhr.response);
            var workbook = XLSX.read(data, { type: 'array' });
            var sheetName = workbook.SheetNames[0];
            var sheet = workbook.Sheets[sheetName];
            var coordinates = [];

            XLSX.utils.sheet_to_json(sheet).forEach(function (row) {
              coordinates.push({ lat: parseFloat(row.lat), lng: parseFloat(row.lng) });
            });

            resolve(coordinates);
          };

          xhr.onerror = function (error) {
            reject(error);
          };

          xhr.send();
        });
      }

      // Function to upload bus coordinates to Firestore
      async function uploadBusCoordinatesToFirestore(files) {
        const busCollection = collection(firestore, "buses");

        for (let index = 0; index < files.length; index++) {
          const file = files[index];
          const coordinates = await loadCoordinatesFromExcel(file);

          for (let subIndex = 0; subIndex < coordinates.length; subIndex++) {
            const coord = coordinates[subIndex];
            try {
              const docRef = await addDoc(busCollection, {
                id: `${index + 1}-${subIndex + 1}`,
                lat: coord.lat,
                lng: coord.lng,
              });
              console.log(`Bus coordinate written with ID: ${docRef.id}`);
            } catch (error) {
              console.error("Error writing bus coordinates: ", error);
            }
          }
        }
      }

      // Function to initialize the map
      function initMap() {
        map = new mappls.Map('map', {
          center: [12.840625, 80.153431],
          zoomControl: true,
          location: true,
        });
        map.setZoom(14);
        var window = new mappls.InfoWindow({
          map: map,
          content: "<div style=\"border-radius:40px; \"'><h2 style=\"font: bold 16px arial helvetica\">Vellore Institue of Technology</h2>" +
            "<p style=\"font: italic 14px/20px times\">Perfect Place To Learn</p>" +
            "<img style=\"width: 200px;height: 100px;\" src=\"https://lh5.googleusercontent.com/p/AF1QipMp5VUqmzb6NGNnwe9qf_fUdR2EmyIwU7tkC0GT=w750-h401-p-k-no\">" +
            "<p>VIT Chennai Vandalur-Kelambakkam Road</p>" +
            "<p><a href=\"https://chennai.vit.ac.in/\" target=\"_blank\">Website link</a></p></div>",
          position: {
            lat: 12.84055556,
            lng: 80.15388889
          },
          fitbounds:true
        });

        // Create polylines from Excel files
        const cD = ['coordinates1.xlsx', 'coordinates2.xlsx', 'coordinates3.xlsx'];
        const strokeColors = ['#FF0000', '#000000', '#1E2F97'];

        for (let i = 0; i < cD.length; i++) {
          createPolylineForExcelFile(cD[i], strokeColors[i]);
        }

        // Upload bus coordinates to Firestore
        uploadBusCoordinatesToFirestore(cD);
      }

      // Call the map initialization function
      initMap();
    }
    </script>
  </body>
</html>

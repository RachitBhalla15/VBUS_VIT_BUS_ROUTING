<!DOCTYPE html>
<html>
<head>
    <title>MAP</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
        html,
        body,
        #map {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100vh;
        }
    </style>
    <script src="https://apis.mappls.com/advancedmaps/api/7e228cc42a410abe8c713c359a3191a1/map_sdk?layer=vector&v=3.0&callback=initMap1" defer async></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.4.4/math.min.js"></script>

</head>
<body>
<div id="map"></div>
<script>
    var map,markers=[],startMarker;
    
/*
    function getDistanceMatrix(locations) {
  const R = 6371; // Earth's radius in km
  const n = locations.length;
  const D = math.zeros(n, n);

  for (let i = 0; i < n; i++) {
    for (let j = i + 1; j < n; j++) {
      const lat1 = locations[i].lat;
      const lng1 = locations[i].lng;
      const lat2 = locations[j].lat;
      const lng2 = locations[j].lng;

      const dLat = math.unit(lat2 - lat1, 'degree');
      const dLng = math.unit(lng2 - lng1, 'degree');
      const a = math.sin(dLat / 2) * math.sin(dLat / 2) +
                math.cos(math.unit(lat1, 'degree')) * math.cos(math.unit(lat2, 'degree')) *
                math.sin(dLng / 2) * math.sin(dLng / 2);
      const c = 2 * math.atan2(math.sqrt(a), math.sqrt(1 - a));
      const distance = R * c;

      D.subset(math.index(i, j), distance);
      D.subset(math.index(j, i), distance);
    }
  }

  return D;
}
*/
    function initMap1() {
        map = new mappls.Map('map', {
            center: [12.840625, 80.153431],
            zoomControl: true,
            location: true,
        });
        map.setZoom(14);
        var window = new mappls.InfoWindow({
                map: map,
                content: "<div style=\"border-radius:40px; \"'><h2 style=\"font: bold 16px arial helvetica\">Vellore Institue of Technology</h2>" +
                    "<p style=\"font: italic 14px/20px times\">Perfect Place To Learn</p>" +
                    "<img style=\"width: 200px;height: 100px;\" src=\"https://lh5.googleusercontent.com/p/AF1QipMp5VUqmzb6NGNnwe9qf_fUdR2EmyIwU7tkC0GT=w750-h401-p-k-no\">" +
                    "<p>VIT Chennai Vandalur-Kelambakkam Road</p>" +
                    "<p><a href=\"https://chennai.vit.ac.in/\" target=\"_blank\">Website link</a></p></div>",
                position: {
                    lat: 12.84055556,
                    lng: 80.15388889
                },
                fitbounds:true
            });

        var cD = ['coordinates1.xlsx', 'coordinates2.xlsx', 'coordinates3.xlsx'];
        var strokeColors = ['#FF0000', '#000000', '#1E2F97']; 

        for (let i = 0; i < cD.length; i++) {
            createPolylineForExcelFile(cD[i], strokeColors[i]);
        }

        var coordinateXYZ = [
            { lat: 12.83641, lng: 80.1554 },
            { lat: 12.918898, lng:80.147998 },
            { lat: 12.843531, lng: 80.149694 },
            { lat: 12.845609, lng: 80.148837 },
            { lat: 12.926414, lng:80.131429 },  //Dest of coord 1
            {lat:12.850301, lng:80.141073}, //dest of coord 2.
            {lat:12.861278,	lng:80.191335},  // dest of coord 3
            {lat:12.907141,lng:80.159321},
            {lat:12.867995,lng:80.147296},
            {lat:12.847011,lng:80.185789},
            {lat:12.885771,lng:80.151066},
            {lat:12.841034,lng:80.163867}


            // Add more coordinates as needed
        ];

        for (var i = 0; i < coordinateXYZ.length; i++) {
            markers.push(new mappls.Marker({
                map: map,
                position: coordinateXYZ[i],
                icon_url: 'https://static.thenounproject.com/png/886617-200.png',
                draggable:false
            }));
        }
        
        /*function rotateCamera(timestamp) {
          map.rotateTo((timestamp / 100) % 360, { duration: 0 });
          requestAnimationFrame(rotateCamera);
        }

        map.on("load", () => {
          rotateCamera(0);
        });*/

        map.on('markersLoaded', function() {
        const locations = markers.map(function(marker) {
        return marker.getPosition();
        });

        // Calculate the distance matrix and ETA
        const D = getDistanceMatrix(locations);
        const speed = 30; // km/h
        const eta = math.divide(D, speed);

        console.log(eta);
        });

    }

    function createPolylineForExcelFile(file, strokeColor) {
        // Load coordinates from Excel sheet
        loadCoordinatesFromExcel(file, function(coordinates) {
            var routeCoordinates = coordinates.map(function(coord) {
                return { lat: coord.lat, lng: coord.lng };
            });

            var routePolyline = new mappls.Polyline({
                map: map,
                path: routeCoordinates,
                strokeColor: strokeColor,
                strokeOpacity: 1.0,
                strokeWeight: 5,
             /*   animate:{
                    path:true,
                    speed: 10
                }
                */
                animate: {
                    speed: 8,
                    icon_width: 20,
                    icon_height: 50,
                    icon_url: "http://www.mapmyindia.com/api/advanced-maps/doc/sample/map_sdk/car.png",
                    repeat: true,
                }
            });
        /*     // Animate the polyline with a specified interval (e.g., 1000ms)
                animatePolyline(routePolyline, 1000, 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTfTu8yzYQydcWHwzxbHmrMHir71XQp12AVSDmZMtEQqw&s');       */
        });
    }

/*    function animatePolyline(polyline, interval, markerIconUrl) {
    var currentIndex = 0;

    // Create a marker for the start of the animation
        startMarker = new mappls.Marker({
        map: map,
        position: polyline.getPath().getAt(0),
        icon_url: markerIconUrl
    });

    // Function to update the marker position and polyline color
    function updateMarkerAndColor() {
        if (currentIndex < polyline.getPath().getLength() - 1) {
            // Update the color of the current polyline segment
            polyline.setOptions({ strokeColor: "#008000" });

            // Move the marker to the next point
            startMarker.setPosition(polyline.getPath().getAt(currentIndex));
            currentIndex++;
        } else {
            // End of animation, clear the interval
            clearInterval(animationInterval);
        }
    }

    // Set up the animation interval
    var animationInterval = setInterval(updateMarkerAndColor, interval);
}
*/

    function loadCoordinatesFromExcel(file, callback) {
        // Create a new XMLHttpRequest object
        var xhr = new XMLHttpRequest();

        // Configure the request to fetch the Excel file
        xhr.open('GET', file, true);

        // Set the response type to 'arraybuffer'
        xhr.responseType = 'arraybuffer';

        // Define what should happen when the request is complete
        xhr.onload = function() {
            // Convert the response data into a Uint8Array
            var data = new Uint8Array(xhr.response);

            // Parse the Excel workbook from the Uint8Array
            var workbook = XLSX.read(data, { type: 'array' });

            // Get the name of the first sheet in the workbook
            var sheetName = workbook.SheetNames[0];

            // Get the data from the first sheet
            var sheet = workbook.Sheets[sheetName];

            // Initialize an array to store the coordinates
            var coordinates = [];

            // Convert the sheet data to JSON and extract coordinates
            XLSX.utils.sheet_to_json(sheet).forEach(function(row) {
                coordinates.push({ lat: parseFloat(row.lat), lng: parseFloat(row.lng) });
            });

            // Invoke the provided callback with the extracted coordinates
            if (callback && typeof callback === 'function') {
                callback(coordinates);
            }
        };

        // Send the XMLHttpRequest to fetch the file
        xhr.send();
    }


    

</script>
</body>
</html>
